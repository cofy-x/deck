# Deck Desktop AI Sandbox

## Deck Image Architecture Evolution

The Deck environment is built through a **four-tier layering process**. This architecture is designed to maximize build cache efficiency and isolate heavy dependencies from rapid code iterations.

1. **`desktop-runtime-base` (L1)**: The foundation. It manages the core OS, user identity (`deck`), and basic system utilities (SSH, Locales).
2. **`desktop-runtime-dev` (L2)**: The productivity layer. Built on L1, it integrates the developer stack: Google Chrome, Go, Node.js (via NVM), and a customized Zsh environment.
3. **`desktop-runtime-ai` (L3)**: **The AI Tooling Isolation Layer**. This tier "freezes" the heavy installation of Claude Code, Gemini CLI, and OpenCode. By isolating these tools here, we avoid re-downloading gigabytes of data when the daemon code changes.
4. **`desktop-sandbox-ai` (L4)**: The execution layer. This final tier injects the **`deck-daemon`**, `computer-use`, and **`deck` CLI** binaries, plus the built-in OpenCode skill `deck-cli`. The daemon acts as **PID 1** and is the primary target for rapid development.

---

## Deck Daemon Design (PID 1)

As the Init process of the container, the `deck-daemon` assumes system-level responsibilities typically handled by an OS kernel.

### 1. Operating System Duties

- **Zombie Process Reaper**: As PID 1, the daemon listens for `SIGCHLD` signals and uses `syscall.Wait4` with `WNOHANG` to adopt and reap orphaned child processes. This prevents zombie processes generated by heavy applications like Chrome from exhausting the process table.
- **Signal Forwarding & Graceful Shutdown**: It captures `SIGTERM` and `SIGINT` signals. Utilizing Process Group IDs (PGID), it ensures that all child processes (Chrome, Xfce, etc.) are terminated gracefully using `syscall.Kill(-pgid, syscall.SIGKILL)`.

### 2. Infrastructure Management

- **D-Bus Stability**: The daemon forces a fixed socket path at `/var/run/dbus/user_bus_socket` and manages directory permissions to ensure reliable IPC.
- **Privilege Separation**: While the daemon starts as root to manage system resources, it drops privileges to run desktop and developer tools as the non-root `deck` user for enhanced security.

---

## Computer-Use Core Capabilities

The daemon implements the `IComputerUse` interface, serving as a "digital prosthetic" for AI agents to interact with the sandbox.

### 1. Process Orchestration

- **Prioritized Bootstrapping**: Services are launched in a strict sequence: `Xvfb` -> `D-Bus` -> `Xfce4` -> `x11vnc` -> `novnc`.
- **Health Monitoring & Self-Healing**: The daemon continuously monitors PIDs and includes an `AutoRestart` mechanism to recover desktop components within seconds if they crash.

### 2. Dynamic Tool Control (Chrome)

- **Dynamic Tooling**: Chrome is launched on-demand via API with specific URLs.
- **Industrial-Grade Optimization**: Flags include `--no-sandbox`, `--test-type` (to remove security banners), and `--remote-debugging-port=9222`.
- **Coordinate Alignment**: Resolution is locked at **1280x720** via `--window-size` to ensure consistent AI visual recognition and click coordinates.
- **CDP Discovery**: Port `9222` allows AI agents to connect via Playwright or Puppeteer for direct DOM manipulation.

---

## Built-in Skill (`deck-cli`) + Deck CLI

The `deck` binary (installed at `/usr/local/bin/deck`) remains available in the sandbox and can still be used for direct CLI workflows against the daemon API on `localhost:2280`.

This image now ships a built-in global OpenCode skill at:

- `/home/deck/.config/opencode/skills/deck-cli`

OpenCode is configured in skills-first mode:

```json
{
  "skills": {
    "paths": ["/home/deck/.config/opencode/skills"]
  }
}
```

Compatibility note:

- `deck mcp serve` is still available in the `deck` binary.
- `desktop-sandbox-ai` no longer injects `mcp.deck-mcp` by default.

---

## Multi-Language & AI Tooling Support

The sandbox provides a managed environment for modern development and AI workflows:

- **AI CLI Stack**: Pre-configured access to `claude`, `gemini`, and `opencode-ai` via the stable L3 layer.
- **Full-Stack Hosting**: Optimized execution for **Go, Python, and Node.js** (v24+) applications.
- **Unified Logging**: `stdout`/`stderr` from all managed processes are redirected to `.deck/logs/*.log` for real-time remote tracking.

---

## API Endpoint Reference

| Category    | Endpoints (REST/RPC)              | Description                                          |
| ----------- | --------------------------------- | ---------------------------------------------------- |
| **System**  | `/status`, `/process-status`      | Health monitoring and desktop lifecycle control.     |
| **Browser** | `/browser/open`, `/browser/close` | Idempotent navigation with remote debugging enabled. |
| **Input**   | `/mouse/click`, `/keyboard/type`  | Human-like input simulation for UI automation.       |
| **Visuals** | `/screenshot/compressed`          | Efficient screen capture for AI processing.          |
| **Debug**   | `/process/:name/logs`             | Real-time log retrieval for managed PIDs.            |
