ARG RUNTIME_VERSION=latest
ARG TARGETARCH=amd64
FROM deck/cli-runtime-ai:${RUNTIME_VERSION}

USER root

# Copy stable OpenCode config and built-in skills first for better layer reuse.
RUN install -d -m 0755 -o ${DECK_USER} -g ${DECK_USER} /home/${DECK_USER}/.config/opencode/skills
COPY --chown=${DECK_USER}:${DECK_USER} docker/cli/sandbox-ai/config/opencode.json /home/${DECK_USER}/.config/opencode/opencode.json
COPY --chown=${DECK_USER}:${DECK_USER} skills/deck-cli /home/${DECK_USER}/.config/opencode/skills/deck-cli

# Copy Daemon and CLI binaries (CLI sandbox does not need computer-use plugin)
COPY dist/linux_amd64/daemon /usr/local/bin/deck-daemon
COPY dist/linux_amd64/cli /usr/local/bin/deck
RUN chown ${DECK_USER}:${DECK_USER} /usr/local/bin/deck-daemon && \
    chown ${DECK_USER}:${DECK_USER} /usr/local/bin/deck

USER ${DECK_USER}
WORKDIR /home/${DECK_USER}

# Daemon still runs as PID 1, responsible for reaping zombie processes generated by CLI
ENTRYPOINT ["/usr/local/bin/deck-daemon"]
